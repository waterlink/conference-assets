// Generated by CoffeeScript 1.6.2
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.UserRegistrationViewModel = (function() {
    function UserRegistrationViewModel() {
      this.isAvailableDateToStay = __bind(this.isAvailableDateToStay, this);      this.start = new Date;
      this.end = new Date;
      this.start.setDate(this.start.getDate() - 7);
      this.end.setDate(this.end.getDate() + 7);
      this.user = {
        name: ko.observable(""),
        surname: ko.observable(""),
        patronymic: ko.observable(""),
        academicDegree: ko.observable(""),
        academicTitle: ko.observable(""),
        jobPosition: ko.observable(""),
        jobPlace: ko.observable(""),
        city: ko.observable(""),
        country: ko.observable("Украина"),
        postalAddress: ko.observable(""),
        email: ko.observable(""),
        phone: ko.observable(""),
        lectureTitle: ko.observable(""),
        sectionNumber: ko.observable(""),
        monographyParticipant: ko.observable(false),
        monographyTitle: ko.observable(""),
        stayDemand: ko.observable(false),
        stayStart: ko.observable(""),
        stayEnd: ko.observable("")
      };
      this.searchData = window.searchData;
      this.errors = ko.validation.group(this.user);
      this.errorAlert = new Alert("#needFixErrors");
    }

    UserRegistrationViewModel.prototype.doRegister = function() {
      var creating, p;

      if (!this.hasValidation) {
        this.addValidation();
      }
      if (this.errors().length === 0) {
        console.log(ko.mapping.toJS(this.user));
        creating = new User;
        creating.fromData(ko.mapping.toJS(this.user));
        p = creating.create();
        return p.done(function(data) {
          if (data) {
            if (data.error) {
              return alert(data.error);
            }
          }
        });
      } else {
        this.errorAlert.show();
        return this.errors.showAllMessages();
      }
    };

    UserRegistrationViewModel.prototype.isAvailableDateToStay = function(date) {
      console.log(date);
      return true;
    };

    UserRegistrationViewModel.prototype.addValidation = function() {
      this.makeFieldsRequired();
      this.user.email.extend({
        email: {
          message: "Введите корректный email",
          params: true
        }
      });
      return this.hasValidation = true;
    };

    UserRegistrationViewModel.prototype.makeFieldsRequired = function() {
      var isRequired, key, value, _ref,
        _this = this;

      _ref = this.user;
      for (key in _ref) {
        value = _ref[key];
        if (!(value.extend != null)) {
          continue;
        }
        isRequired = true;
        if (key === "stayStart" || key === "stayEnd") {
          isRequired = {
            onlyIf: this.user.stayDemand
          };
        }
        if (key === "monographyTitle") {
          isRequired = {
            onlyIf: this.user.monographyParticipant
          };
        }
        if (key === "monographyParticipant" || key === "stayDemand") {
          isRequired = false;
        }
        if (value != null) {
          value.extend({
            required: isRequired
          });
        }
      }
      this.user.stayDemand.subscribe(function(value) {
        ko.validation.validateObservable(_this.user.stayStart);
        return ko.validation.validateObservable(_this.user.stayEnd);
      });
      return this.user.monographyParticipant.subscribe(function(value) {
        return ko.validation.validateObservable(_this.user.monographyTitle);
      });
    };

    return UserRegistrationViewModel;

  })();

}).call(this);
