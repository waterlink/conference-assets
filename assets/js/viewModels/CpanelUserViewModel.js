// Generated by CoffeeScript 1.6.2
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  global.Restfull = require("../classes/restfull");

  global.UserViewModel = require("../assets/js/viewModels/UserViewModel");

  window.CpanelUserViewModel = (function(_super) {
    __extends(CpanelUserViewModel, _super);

    function CpanelUserViewModel(user) {
      var _this = this;

      CpanelUserViewModel.__super__.constructor.call(this, user);
      this["default"] = user;
      this._monographyParticipant = ko.observable(this.monographyParticipant);
      this.monographyParticipant = ko.computed({
        read: function() {
          return _this._monographyParticipant() && _this._monographyParticipant() !== "0";
        },
        write: function(v) {
          return _this._monographyParticipant(v);
        }
      });
      this.monographyTitle = ko.observable(this.monographyTitle || "");
      this._stayDemand = ko.observable(this.stayDemand);
      this.stayDemand = ko.computed({
        read: function() {
          return _this._stayDemand() && _this._stayDemand() !== "0";
        },
        write: function(v) {
          return _this._stayDemand(v);
        }
      });
      this.locStatus = ko.computed(function() {
        var res;

        res = "" + statuses[_this.status()];
        if (_this.status() === "new") {
          res += " (к оплате: " + _this.thesisPay;
          if (_this.monographyParticipant()) {
            res += " + " + _this.monographyPay;
          }
          res += " " + searchData.costCurrency + ")";
        }
        return res;
      });
      this.mailto = ko.computed(function() {
        return "mailto:" + _this.email;
      });
      this.nextStatus = ko.computed(function() {
        return statuses[statusGraph.next[_this.status()]];
      });
      this.prevStatus = ko.computed(function() {
        return statuses[statusGraph.prev[_this.status()]];
      });
      this.fullJob = ko.computed(function() {
        return "" + _this.jobPosition + " в " + _this.jobPlace + " г. " + _this.city + ", " + _this.country;
      });
      this.z_monographyTitle = ko.computed(function() {
        return _this.monographyTitle();
      });
      this.z_stayStart = ko.computed(function() {
        return _this.stayStart();
      });
      this.z_stayEnd = ko.computed(function() {
        return _this.stayEnd();
      });
      this.isMonographyParticipant = ko.computed(function() {
        return _this.monographyParticipant() && _this.monographyParticipant() !== "0";
      });
      this.isStayDemand = ko.computed(function() {
        return _this.stayDemand && _this.stayDemand !== "0";
      });
      this.z_participantType = ko.computed(function() {
        return _this.participantType || "";
      });
      this.downloadLink = ko.computed(function() {
        return "/uploads/download/" + _this.id;
      });
      this.isNew = ko.computed(function() {
        return _this.status() === "new";
      });
    }

    CpanelUserViewModel.prototype.details = function() {
      return cpanel.userDetails(this.id);
    };

    CpanelUserViewModel.prototype.goNextStatus = function() {
      var nextAction, onError, p,
        _this = this;

      nextAction = statusGraph.next[this.status()];
      if (nextAction) {
        p = cpanel.userStatus(this.id, nextAction);
        $(".user-table-row[user_id=\"" + this.id + "\"] .user-actions .dropdown-toggle").button("loading");
        onError = function() {
          return $(".user-table-row[user_id=\"" + _this.id + "\"] .user-actions .dropdown-toggle").button("error");
        };
        p.done(function(e) {
          var user;

          if (e && e.error) {
            return onError();
          }
          user = new User;
          p = user.getById(_this.id);
          p.done(function(user) {
            if (!user || user.error) {
              return onError();
            }
            _this.status(user.status);
            return $(".user-table-row[user_id=\"" + _this.id + "\"] .user-actions .dropdown-toggle").button("reset");
          });
          return p.error(onError);
        });
        return p.error(onError);
      }
    };

    CpanelUserViewModel.prototype.goPrevStatus = function() {
      var onError, p, prevAction,
        _this = this;

      prevAction = statusGraph.prev[this.status()];
      if (prevAction) {
        p = cpanel.userStatus(this.id, prevAction);
        $(".user-table-row[user_id=\"" + this.id + "\"] .user-actions .dropdown-toggle").button("loading");
        onError = function() {
          return $(".user-table-row[user_id=\"" + _this.id + "\"] .user-actions .dropdown-toggle").button("error");
        };
        p.done(function(e) {
          var user;

          if (e && e.error) {
            return onError();
          }
          user = new User;
          p = user.getById(_this.id);
          p.done(function(user) {
            if (!user || user.error) {
              return onError();
            }
            _this.status(user.status);
            return $(".user-table-row[user_id=\"" + _this.id + "\"] .user-actions .dropdown-toggle").button("reset");
          });
          return p.error(onError);
        });
        return p.error(onError);
      }
    };

    CpanelUserViewModel.prototype.getData = function() {
      var k, res;

      res = {
        name: this.name(),
        surname: this.surname(),
        patronymic: this.patronymic(),
        participant: this.participant,
        status: this.status(),
        academicDegree: this.academicDegree(),
        academicTitle: this.academicTitle(),
        jobPosition: this.jobPosition(),
        jobPlace: this.jobPlace(),
        city: this.city(),
        country: this.country(),
        postalAddress: this.postalAddress(),
        email: this.email(),
        phone: this.phone(),
        participantType: this.participantType(),
        lectureTitle: this.lectureTitle(),
        sectionNumber: this.sectionNumber(),
        monographyParticipant: this.monographyParticipant(),
        stayDemand: this.stayDemand(),
        uploadId: this.uploadId
      };
      if (this.monographyParticipant()) {
        res["monographyTitle"] = this.monographyTitle();
      }
      if (this.stayDemand()) {
        res["stayStart"] = this.stayStart();
        res["stayEnd"] = this.stayEnd();
      }
      for (k in res) {
        if (res[k] === void 0 || res[k] === "" || res[k] === null) {
          res[k] = this["default"][k];
        }
      }
      return res;
    };

    CpanelUserViewModel.prototype.doSave = function(d, e) {
      var $e, p, rest,
        _this = this;

      console.log(this.getData());
      $e = $(e.target);
      $e.button("loading");
      rest = new Restfull;
      p = rest.put(["user", "" + this.id], this.getData());
      return p.done(function(e) {
        if (e && e.error) {
          alert(e.error);
        }
        return $e.button("reset");
      });
    };

    return CpanelUserViewModel;

  })(window.UserViewModel);

  module.exports = window.CpanelUserViewModel;

}).call(this);
