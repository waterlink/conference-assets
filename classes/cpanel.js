// Generated by CoffeeScript 1.6.2
(function() {
  var Cpanel,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  global.Restfull = require("../classes/restfull");

  global.Auth = require("../classes/auth");

  global.User = require("../classes/user");

  global.AdminViewModel = require("../assets/js/viewModels/AdminViewModel");

  global.statuses = {
    "new": "Новый",
    "emailsent": "Письмо отослано",
    "paid": "Оплачено"
  };

  global.statusGraph = {
    next: {
      "new": "emailsent",
      "emailsent": "paid"
    },
    prev: {
      "emailsent": "new",
      "paid": "emailsent"
    }
  };

  global.cpanelPageLimit = 10;

  Cpanel = (function() {
    function Cpanel() {
      this.showOperatorLogin = __bind(this.showOperatorLogin, this);
      this.redirectToLogin = __bind(this.redirectToLogin, this);
      this.ready = __bind(this.ready, this);      this.rest = new Restfull;
      this.auth = new Auth(this.rest);
      this.auth.login({
        ok: this.ready,
        fail: this.redirectToLogin
      });
    }

    Cpanel.prototype.ready = function() {
      this.showOperatorLogin();
      this.adminViewModel = new AdminViewModel;
      ko.applyBindings(this.adminViewModel);
      this.setup();
      return this.loadUsers();
    };

    Cpanel.prototype.redirectToLogin = function() {
      return global.location = "login.html#apanel.html";
    };

    Cpanel.prototype.showOperatorLogin = function() {
      return $('#operator_login_content').text("@" + this.auth.whois);
    };

    Cpanel.prototype.logoff = function() {
      var p,
        _this = this;

      p = this.rest["delete"]("index");
      return p.done(function() {
        return _this.redirectToLogin();
      });
    };

    Cpanel.prototype.setup = function() {
      var me,
        _this = this;

      me = this;
      this.filter = {
        skip: 0,
        limit: global.cpanelPageLimit
      };
      this.page = 0;
      $('#operator_logoff').click(function() {
        return _this.logoff();
      });
      $('.status-filter').click(function() {
        return me.statusFilterChanged($(this).attr("rel"));
      });
      return $('.status-filter[rel="new"]').click();
    };

    Cpanel.prototype.statusFilterChanged = function(status) {
      if (this.filter.status) {
        if (this.filter.status === status) {
          $(".status-filter[rel=\"" + status + "\"]").removeClass("active");
          delete this.filter.status;
        } else {
          $(".status-filter[rel=\"" + this.filter.status + "\"]").removeClass("active");
          this.filter.status = status;
          $(".status-filter[rel=\"" + status + "\"]").addClass("active");
        }
      } else {
        this.filter.status = status;
        $(".status-filter[rel=\"" + status + "\"]").addClass("active");
      }
      return this.loadUsers();
    };

    Cpanel.prototype.loadOperators = function(cb) {
      var p,
        _this = this;

      p = this.rest.get("operator");
      return p.done(function(operators) {
        var operator, _i, _len;

        _this.adminViewModel.operators.removeAll();
        for (_i = 0, _len = operators.length; _i < _len; _i++) {
          operator = operators[_i];
          _this.adminViewModel.operators.push(new OperatorViewModel(operator));
        }
        if (cb) {
          return cb();
        }
      });
    };

    Cpanel.prototype.loadUsers = function() {
      var p, search, user, words,
        _this = this;

      search = this.adminViewModel.search();
      if (search) {
        if (!search.match(/^[0-9]+$/)) {
          words = search.split(" ").filter(function(x) {
            return x;
          });
          words = _.map(words, function(x) {
            return x.toLowerCase();
          });
          if (words) {
            this.filter.words = words;
          } else {
            delete this.filter.words;
          }
        } else {
          delete this.filter.words;
        }
      } else if (this.filter.words) {
        delete this.filter.words;
      }
      console.log(this.filter.words);
      if (search.match(/^[0-9]+$/)) {
        user = new User;
        p = user.getById(search);
        return p.done(function(user) {
          _this.users = {};
          _this.adminViewModel.users.removeAll();
          console.log(user);
          if (user) {
            _this.users[user.id] = user;
            _this.adminViewModel.users.push(new CpanelUserViewModel(user));
            return _this.adminViewModel.userCount(1);
          }
        });
      } else {
        p = this.rest.get("user", this.filter);
        return p.done(function(users) {
          var _i, _len, _results;

          _this.users = {};
          _this.adminViewModel.users.removeAll();
          _this.adminViewModel.userCount(0);
          _results = [];
          for (_i = 0, _len = users.length; _i < _len; _i++) {
            user = users[_i];
            _this.users[user.id] = user;
            _this.adminViewModel.users.push(new CpanelUserViewModel(user));
            _results.push(_this.adminViewModel.userCount(_this.adminViewModel.userCount() + 1));
          }
          return _results;
        });
      }
    };

    Cpanel.prototype.userSetup = function(user, userMarkup) {
      var detailsAction, eventSetup, nextAction, nextActionMarkup, prevAction, prevActionMarkup, userActions, userEmail, userFIO, userId, userPhone, userStatus,
        _this = this;

      this.users[user.id] = user;
      if (!userMarkup) {
        eventSetup = true;
        userMarkup = $(".repo-user");
        userMarkup = userMarkup.clone().removeClass("hide");
        userMarkup.removeClass("repo-user");
        userMarkup.attr("user_id", "" + user.id);
      }
      userId = userMarkup.find(".user-id");
      userId.text(user.id);
      userFIO = userMarkup.find(".user-fio");
      userFIO.text("" + user.surname + " " + user.name + " " + user.patronymic);
      userEmail = userMarkup.find(".user-email");
      userEmail.text(user.email);
      userEmail.attr("href", "mailto:" + user.email);
      userPhone = userMarkup.find(".user-phone");
      userPhone.text(user.phone);
      userStatus = userMarkup.find(".user-status");
      userStatus.text(statuses[user.status]);
      userMarkup.addClass("user-real");
      userActions = userMarkup.find(".user-actions");
      nextAction = statusGraph.next[user.status];
      prevAction = statusGraph.prev[user.status];
      nextActionMarkup = userActions.find(".user-action-nextstate");
      prevActionMarkup = userActions.find(".user-action-prevstate");
      if (nextAction) {
        nextActionMarkup.parent().removeClass("hide");
      } else {
        nextActionMarkup.parent().addClass("hide");
      }
      if (prevAction) {
        prevActionMarkup.parent().removeClass("hide");
      } else {
        prevActionMarkup.parent().addClass("hide");
      }
      if (nextAction) {
        nextActionMarkup.text(statuses[nextAction]);
      }
      if (prevAction) {
        prevActionMarkup.text(statuses[prevAction]);
      }
      detailsAction = userActions.find("user-action-details");
      detailsAction.unbind().click(function() {
        return _this.userDetails(user.id);
      });
      prevActionMarkup.unbind().click(function() {
        return _this.userStatus(user.id, prevAction);
      });
      nextActionMarkup.unbind().click(function() {
        return _this.userStatus(user.id, nextAction);
      });
      return userMarkup;
    };

    Cpanel.prototype.userDetails = function(id) {
      var _this = this;

      this.adminViewModel.activeUser(id);
      this.adminViewModel.backToUsersLeftIsHidden(false);
      this.adminViewModel.initialOffset = $("#user_page").offset();
      $("#user_page").addClass("cpanel-navigation-goaway-left");
      return setTimeout(function() {
        var user_card;

        user_card = $(".user-pages .container[user_id=\"" + id + "\"]");
        user_card.css({
          position: "fixed",
          left: _this.adminViewModel.initialOffset.left,
          top: _this.adminViewModel.initialOffset.top
        });
        user_card.removeClass("cpanel-navigation-goaway-right");
        _this.active_page = user_card;
        return setTimeout(function() {
          return user_card.attr("style", "");
        }, 500);
      }, 50);
    };

    Cpanel.prototype.userStatus = function(id, status) {
      var p, user, userMarkup;

      userMarkup = $(".user-real[user_id=\"" + id + "\"]");
      user = new User;
      user.fromData(this.users[id]);
      return p = user.update(id, status);
    };

    return Cpanel;

  })();

  module.exports = Cpanel;

}).call(this);
